import os
import tempfile
import time
import sys

from pathlib import Path

import click

from infra_visualiser_action.artifact import GitHubArtifactClient
from infra_visualiser_action.client import create_archive, upload_archive_to_host, notify_server
from infra_visualiser_action.git import has_terraform_changes_in_paths, mark_dir_safe
from infra_visualiser_action.oidc import get_oidc_token_for_host
from infra_visualiser_action.tf import find_local_modules_from_modules_json, find_tfvars_files, run_plans


# Top-level CLI with click
@click.command()
@click.option(
    "--directory",
    "directory",
    required=True,
    envvar="INPUT_DIRECTORY",
    help="Path (relative to repo root) to the Terraform/OpenTofu recipe.",
)
@click.option(
    "--recipe-nickname",
    required=True,
    envvar="INPUT_RECIPE_NICKNAME",
    help="Human-friendly nickname for this recipe.",
)
@click.option(
    "--host",
    required=True,
    envvar="INPUT_HOST",
    help="Base URL of the platform host (used as OIDC audience and upload target).",
)
@click.option(
    "--gcp-credentials-json",
    "gcp_credentials_json",
    required=False,
    envvar="INPUT_GCP_CREDENTIALS_JSON",
    help="GCP service account JSON credentials for authenticating with Google Cloud Provider.",
)
@click.option(
    "--use-terraform",
    "use_terraform",
    is_flag=True,
    default=False,
    envvar="INPUT_USE_TERRAFORM",
    help="Use Terraform instead of OpenTofu for init and plan commands.",
)
@click.option(
    "--upload-to-github",
    "upload_to_github",
    is_flag=True,
    default=False,
    envvar="INPUT_UPLOAD_TO_GITHUB",
    help="Upload the generated archive as a GitHub Artifact and notify the server.",
)
@click.option(
    "--github-token",
    "github_token",
    required=False,
    envvar="INPUT_GITHUB_TOKEN",
    help="GitHub Token (required if upload_to_github is true).",
)
@click.option(
    "--include-markdown",
    "include_markdown",
    is_flag=True,
    default=False,
    envvar="INPUT_INCLUDE_MARKDOWN",
    help="Also add markdown (*.md) files from the recipe directory to the archive.",
)
def main(
    directory: str,
    recipe_nickname: str,
    host: str,
    gcp_credentials_json: str | None,
    use_terraform: bool,
    upload_to_github: bool,
    github_token: str | None,
    include_markdown: bool,
) -> None:
    """
    Run OpenTofu discovery against a Terraform recipe, create an archive, and upload it.
    Intended to be called from a GitHub Action step.
    """
    repo_root = Path(os.environ.get("GITHUB_WORKSPACE", ".")).resolve()
    recipe_dir = (repo_root / directory).resolve()

    click.echo(f"Repository root: {repo_root}")
    click.echo(f"Recipe directory: {recipe_dir}")

    if gcp_credentials_json:
        click.echo("üîë Setting up GCP credentials...")
        gcp_creds_file = Path(tempfile.gettempdir()) / "gcp-credentials.json"
        gcp_creds_file.write_text(gcp_credentials_json, encoding="utf-8")
        # Set restrictive permissions (read-only for owner)
        gcp_creds_file.chmod(0o600)
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = str(gcp_creds_file)
        click.echo(f"  ‚úÖ GCP credentials written to {gcp_creds_file}")

    click.echo(" üîé Discovering .tfvars files...")
    tfvars_files = find_tfvars_files(repo_root)
    for f in tfvars_files:
        click.echo(f"  found: {f}")

    binary = "terraform" if use_terraform else "tofu"
    click.echo(f"üöÄ Running {binary} plans...")
    attempts, any_success = run_plans(recipe_dir, tfvars_files, use_terraform=use_terraform)

    if not any_success:
        click.echo(f"‚ùå No successful {binary} plan. See logs for details:", err=True)
        for a in attempts:
            click.echo(
                f"""
 - {a.env_label}: success={a.success}, log={a.log_path}
   üìÑ Log output:


{a.log_path.read_text()}



   üìÑ end of log output
 """,
                err=True,
            )

        sys.exit(1)

    sha = os.environ.get("GITHUB_SHA", "unknown")
    ts = int(time.time())
    safe_recipe = directory.replace("/", "-").strip("-") or "root"
    archive_name = f"terraform_{safe_recipe}_{sha}_{ts}.tar.gz"
    archive_path = Path(tempfile.gettempdir()) / archive_name

    modules_json = recipe_dir / ".terraform" / "modules" / "modules.json"
    local_modules = find_local_modules_from_modules_json(modules_json, recipe_dir)

    mark_dir_safe(repo_root)
    if not has_terraform_changes_in_paths(
        [l.relative_to(repo_root) for l in local_modules]+[recipe_dir.relative_to(repo_root)],
        repo_root
    ):
        click.echo("No relevant Terraform files changes found. Skipping archive creation.")
        sys.exit(0)

    click.echo(f"üì¶ Creating archive at {archive_path}...")
    create_archive(
        repo_root,
        recipe_dir,
        archive_path,
        extra_paths=local_modules,
        include_markdown=include_markdown,
    )

    click.echo("üîë Requesting OIDC token from GitHub...")
    oidc_token = get_oidc_token_for_host(host)

    if upload_to_github:
        click.echo("üèóÔ∏è Uploading archive as GitHub Artifact...")
        client = GitHubArtifactClient(github_token=github_token)

        # Determine a clean artifact name
        # We drop the .tar.gz extension for the artifact name itself usually
        artifact_name = archive_name.replace(".tar.gz", "")

        try:
            download_url = client.upload_artifact(
                name=artifact_name,
                file_path=archive_path
            )
        except click.ClickException as e:
            click.echo(f"‚ùå Artifact upload failed: {e}", err=True)
            sys.exit(1)

        click.echo(f"  ‚úÖ Artifact URL: {download_url}")

        click.echo(f"üîî Notifying server at {host}...")
        notify_server(
            host=host,
            oidc_token=oidc_token,
            recipe_path=directory,
            recipe_nickname=recipe_nickname,
            artifact_url=download_url,
        )

    else:
        # Legacy behavior: Upload directly to host (if host supports file upload)
        click.echo(f"üèóÔ∏è Uploading archive to {host} (direct upload)...")
        upload_archive_to_host(
            host=host,
            archive_path=archive_path,
            oidc_token=oidc_token,
            recipe_path=directory,
            recipe_nickname=recipe_nickname,
        )

    click.echo("Done.")


if __name__ == "__main__":
    main()

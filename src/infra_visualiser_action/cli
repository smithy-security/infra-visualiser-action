import os
import tempfile
import time

from pathlib import Path

import click

from infra_visualiser_action.tofu import find_local_modules_from_modules_json, find_tfvars_files, run_tofu_plans
from infra_visualiser_action.oidc import get_oidc_token_for_host
from infra_visualiser_action.client import create_archive, upload_archive_to_host

# Top-level CLI with click
@click.command()
@click.option(
    "--directory",
    "directory",
    required=True,
    envvar="INPUT_DIRECTORY",
    help="Path (relative to repo root) to the Terraform/OpenTofu recipe.",
)
@click.option(
    "--recipe-nickname",
    required=True,
    envvar="INPUT_RECIPE_NICKNAME",
    help="Human-friendly nickname for this recipe.",
)
@click.option(
    "--host",
    required=True,
    envvar="INPUT_HOST",
    help="Base URL of the platform host (used as OIDC audience and upload target).",
)
@click.option(
    "--gcp-credentials-json",
    "gcp_credentials_json",
    required=False,
    envvar="INPUT_GCP_CREDENTIALS_JSON",
    help="GCP service account JSON credentials for authenticating with Google Cloud Provider.",
)
def main(directory: str, recipe_nickname: str, host: str, gcp_credentials_json: str | None) -> None:
    """
    Run OpenTofu discovery against a Terraform recipe, create an archive, and upload it.
    Intended to be called from a GitHub Action step.
    """
    repo_root = Path(os.environ.get("GITHUB_WORKSPACE", ".")).resolve()
    recipe_dir = (repo_root / directory).resolve()

    click.echo(f"Repository root: {repo_root}")
    click.echo(f"Recipe directory: {recipe_dir}")

    # 0. Set up GCP credentials if provided
    if gcp_credentials_json:
        click.echo("üîë Setting up GCP credentials...")
        gcp_creds_file = Path(tempfile.gettempdir()) / "gcp-credentials.json"
        gcp_creds_file.write_text(gcp_credentials_json, encoding="utf-8")
        # Set restrictive permissions (read-only for owner)
        gcp_creds_file.chmod(0o600)
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = str(gcp_creds_file)
        click.echo(f"  ‚úÖ GCP credentials written to {gcp_creds_file}")

    # 1. Discover .tfvars files in the repo
    click.echo(" üîé Discovering .tfvars files...")
    tfvars_files = find_tfvars_files(repo_root)
    for f in tfvars_files:
        click.echo(f"  found: {f}")

    # 2. Run tofu plans
    click.echo("üöÄ Running tofu plans...")
    attempts, any_success = run_tofu_plans(recipe_dir, tfvars_files)

    if not any_success:
        click.echo("‚ùå No successful tofu plan. See logs for details:", err=True)
        for a in attempts:
            click.echo(
                f" - {a.env_label}: success={a.success}, log={a.log_path}",
                err=True,
            )

        os.exit(1)

    sha = os.environ.get("GITHUB_SHA", "unknown")
    ts = int(time.time())
    safe_recipe = directory.replace("/", "-").strip("-") or "root"
    archive_name = f"terraform_{safe_recipe}_{sha}_{ts}.tar.gz"
    archive_path = Path(tempfile.gettempdir()) / archive_name

    # Local modules from modules.json
    modules_json = recipe_dir / ".terraform" / "modules" / "modules.json"
    local_modules = find_local_modules_from_modules_json(modules_json, repo_root)

    click.echo(f"üì¶ Creating archive at {archive_path}...")
    create_archive(recipe_dir, archive_path, extra_paths=local_modules)

    # 5. Get OIDC token
    click.echo("üîë Requesting OIDC token from GitHub...")
    oidc_token = get_oidc_token_for_host(host)

    # 6. Upload archive
    click.echo(f"üèóÔ∏è Uploading archive to {host}...")
    upload_archive_to_host(
        host=host,
        archive_path=archive_path,
        oidc_token=oidc_token,
        recipe_path=directory,
        recipe_nickname=recipe_nickname,
    )

    click.echo("Done.")


if __name__ == "__main__":
    main()
